{% extends "plastickothay/base.html" %}
{% load static %}
{% block main_content %}
        <div class="post-container">
            <h1>All Posts</h1>
            <div class="modern-filter-container">
                <div class="filter-section">
                    <label class="filter-label">
                        <i class="fas fa-clock"></i>
                        <span>Time Filter</span>
                    </label>
                    <div class="time-filter-buttons">
                        <button class="time-filter-btn {% if request.GET.filter == 'all' or not request.GET.filter %}active{% endif %}" data-value="all">All</button>
                        <button class="time-filter-btn {% if request.GET.filter == 'today' %}active{% endif %}" data-value="today">Today</button>
                        <button class="time-filter-btn {% if request.GET.filter == 'last_week' %}active{% endif %}" data-value="last_week">Last Week</button>
                        <button class="time-filter-btn {% if request.GET.filter == 'last_28_days' %}active{% endif %}" data-value="last_28_days">Last 28 Days</button>
                    </div>
                </div>
                
                <div class="filter-section">
                    <label class="filter-label">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Severity Filter</span>
                    </label>
                    <div class="severity-slider-container">
                        <input type="range" id="severitySlider" class="severity-slider" min="0" max="5" value="0" step="1">
                        <div class="severity-labels-container">
                            <span class="severity-label active" data-value="0">All</span>
                            <span class="severity-label" data-value="1">1</span>
                            <span class="severity-label" data-value="2">2</span>
                            <span class="severity-label" data-value="3">3</span>
                            <span class="severity-label" data-value="4">4</span>
                            <span class="severity-label" data-value="5">5</span>
                        </div>
                    </div>
                </div>

                {% if user.is_authenticated and user.user_type != 3 %}
                <div class="filter-section">
                    <label class="filter-label">
                        <i class="fas fa-filter"></i>
                        <span>Status Filter</span>
                    </label>
                    <div class="status-toggle-container">
                        <button class="status-toggle {% if request.GET.filter == 'accepted' %}active{% endif %}" data-value="accepted">Accepted</button>
                        <button class="status-toggle {% if request.GET.filter == 'pending' %}active{% endif %}" data-value="pending">Pending</button>
                    </div>
                </div>
                {% endif %}
            </div>
            <div id="posts-container">
            {% if posts|length > 0 %}
                {% if user.is_authenticated and user.user_type != 3 %}
                    {% for post in posts %}
                        <div class="post-card">
                            <div class="post-card-left">
                                {% if post.imageID %}
                                <div class="image-container">
                                    <img src="https://drive.google.com/thumbnail?id={{ post.imageID }}" alt="Post Image">
                                </div>
                                {% endif %}
                            </div>

                            <div class="post-card-right">
                                <div class="post-action">
                                    {% if post.status == 2 %}
                                        <button class="accept" onclick="window.location.href = '{% url "superadmin:accept" post.id %}?next={{ request.path }}'">Accept</button>
                                    {% endif %}
                                    <button class="reject" onclick="window.location.href = '{% url "superadmin:reject" post.id %}?next={{ request.path }}'">Delete</button>
                                    <p><strong>Status:</strong> {% if post.status == 1 %}Accepted{% elif post.status == 2 %}Pending{% endif %}</p>
                                </div>
                                <h2>{{ post.name }}</h2>
                                <p><strong>Email:</strong> {{ post.email }}</p>
                                <p><strong>Phone Number:</strong> {{ post.pN }}</p>
                                <p><strong>Severity:</strong>
                                    <label for="severity">Pollution Severity (1-5):</label>
                                    <div class="severity-container">
                                        <input type="range" id="severity" name="severityData" min="1" max="5" value="{{ post.severity }}" disabled>
                                        <div class="severity-labels">
                                            <span>1</span>
                                            <span>2</span>
                                            <span>3</span>
                                            <span>4</span>
                                            <span>5</span>
                                        </div>
                                    </div>
                                </p>                      
                                {% comment %} <p><strong>Lat:</strong> {{ post.lat }}&nbsp & &nbsp<strong>Lon:</strong> {{ post.lon }}</p>                     {% endcomment %}
                                {% comment %} <div class="description-container">
                                    <strong>Description:</strong>
                                    <p>{{ post.description }}</p>
                                </div> {% endcomment %}
                                <p><strong>Date:</strong> {{ post.created }}</p>
                                <a href='{% url "plastickothay:post" post.id %}' class="view">View Post</a>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    {% for post in posts %}
                        {% if post.status == 1 %}
                            <div class="post-card">
                                <div class="post-card-left">
                                    {% if post.imageID %}
                                    <div class="image-container">
                                        <img src="https://drive.google.com/thumbnail?id={{ post.imageID }}" alt="Post Image">
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="post-card-right">
                                    <h2>{{ post.name }}</h2>
                                    {% comment %} <p><strong>Email:</strong> {{ post.email }}</p>
                                    <p><strong>Phone Number:</strong> {{ post.pN }}</p> {% endcomment %}
                                    <p><strong>Severity:</strong>
                                        <label for="severity">Pollution Severity (1-5):</label>
                                        <div class="severity-container">
                                            <input type="range" id="severity" name="severityData" min="1" max="5" value="{{ post.severity }}" disabled>
                                            <div class="severity-labels">
                                                <span>1</span>
                                                <span>2</span>
                                                <span>3</span>
                                                <span>4</span>
                                                <span>5</span>
                                            </div>
                                        </div>
                                    </p>                      
                                    {% comment %} <p><strong>Lat:</strong> {{ post.lat }}&nbsp & &nbsp<strong>Lon:</strong> {{ post.lon }}</p>                     {% endcomment %}
                                    {% comment %} <div class="description-container">
                                        <strong>Description:</strong>
                                        <p>{{ post.description }}</p>
                                    </div> {% endcomment %}
                                    <p><strong>Date:</strong> {{ post.created }}</p>
                                    <a href='{% url "plastickothay:post" post.id %}' class="view">View Post</a>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% else %}
                <div class="post-card">
                    No post found
                </div>
            {% endif %}
            </div>
        </div>
        <div id="load-more-container">
        {% if posts|length >= 10 %}
            <button class="loadBtn" onclick="window.location.href = '?index=5'">Load More</button>
        {% endif %}
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get current filter from URL
            const urlParams = new URLSearchParams(window.location.search);
            const currentFilter = urlParams.get('filter') || 'all';

            // Time filter buttons
            const timeFilterButtons = document.querySelectorAll('.time-filter-btn');
            timeFilterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    // Reset severity when time filter is selected
                    const severitySlider = document.getElementById('severitySlider');
                    if (severitySlider) {
                        severitySlider.value = 0;
                        const severityLabels = document.querySelectorAll('.severity-label');
                        severityLabels.forEach(label => {
                            const labelValue = parseInt(label.getAttribute('data-value'));
                            if (labelValue === 0) {
                                label.classList.add('active');
                            } else {
                                label.classList.remove('active');
                            }
                        });
                    }
                    applyFilter(value);
                });
            });

            // Initialize severity slider
            const severitySlider = document.getElementById('severitySlider');
            const severityLabels = document.querySelectorAll('.severity-label');
            if (currentFilter.startsWith('severity_')) {
                const severityValue = parseInt(currentFilter.split('_')[1]);
                if (severitySlider) {
                    severitySlider.value = severityValue;
                }
                updateSeverityLabels(severityValue);
            } else {
                if (severitySlider) {
                    severitySlider.value = 0;
                }
                updateSeverityLabels(0);
            }

            // Severity slider with debounce for smooth experience
            let severityTimeout;
            if (severitySlider) {
                severitySlider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    updateSeverityLabels(value);
                    
                    // Clear previous timeout
                    clearTimeout(severityTimeout);
                    
                    // Debounce the filter application
                    severityTimeout = setTimeout(function() {
                        if (value === 0) {
                            loadPostsAjax('all');
                        } else {
                            loadPostsAjax('severity_' + value);
                        }
                    }, 300); // Wait 300ms after user stops sliding
                });
            }

            // Severity label clicks
            severityLabels.forEach(label => {
                label.addEventListener('click', function() {
                    const value = parseInt(this.getAttribute('data-value'));
                    if (severitySlider) {
                        severitySlider.value = value;
                    }
                    updateSeverityLabels(value);
                    if (value === 0) {
                        loadPostsAjax('all');
                    } else {
                        loadPostsAjax('severity_' + value);
                    }
                });
            });

            // Status toggles
            const statusToggles = document.querySelectorAll('.status-toggle');
            statusToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    // Reset severity when status filter is selected
                    if (severitySlider) {
                        severitySlider.value = 0;
                        updateSeverityLabels(0);
                    }
                    applyFilter(value);
                });
            });

            function applyFilter(filterValue) {
                const url = new URL(window.location.href);
                url.searchParams.set('filter', filterValue);
                window.location.href = url.toString();
            }

            function loadPostsAjax(filterValue) {
                // Show loading state
                const postsContainer = document.getElementById('posts-container');
                const loadMoreContainer = document.getElementById('load-more-container');
                postsContainer.classList.add('loading');
                
                // Update URL without reload
                const url = new URL(window.location.href);
                url.searchParams.set('filter', filterValue);
                window.history.pushState({}, '', url.toString());
                
                // Fetch posts via AJAX
                fetch(url.toString(), {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => response.text())
                .then(html => {
                    // Create a temporary container to parse the HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Extract posts container and load more container from response
                    const newPostsContainer = tempDiv.querySelector('#posts-container');
                    const newLoadMoreContainer = tempDiv.querySelector('#load-more-container');
                    
                    if (newPostsContainer) {
                        // Fade out, update, then fade in
                        postsContainer.style.opacity = '0';
                        setTimeout(() => {
                            postsContainer.innerHTML = newPostsContainer.innerHTML;
                            postsContainer.style.opacity = '1';
                            postsContainer.classList.remove('loading');
                        }, 150);
                    }
                    
                    if (newLoadMoreContainer) {
                        loadMoreContainer.innerHTML = newLoadMoreContainer.innerHTML;
                    } else {
                        loadMoreContainer.innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error('Error loading posts:', error);
                    postsContainer.classList.remove('loading');
                    postsContainer.style.opacity = '1';
                });
            }

            function updateSeverityLabels(activeValue) {
                severityLabels.forEach(label => {
                    const value = parseInt(label.getAttribute('data-value'));
                    if (value === activeValue) {
                        label.classList.add('active');
                    } else {
                        label.classList.remove('active');
                    }
                });
            }
        });
    </script>
{% endblock main_content %}
{% block title_content %}All Posts{% endblock title_content %}