{% extends "superadmin/base.html" %}
{% load static %}
{% block main-content %}
<style>
    .wish {
        padding-bottom: 1rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .map-container {
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      width: 100%;
      height: 400px; /* You can adjust */
    }

    #admin_map {
      width: 100%;
      height: 100%;
    }

    .card {
      padding: 2rem 1rem;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      text-align: center;
    }

    .table-responsive {
      width: 100%;
      margin-top: 2rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      overflow-x: auto;
    }

    table {
      min-width: 800px;
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #f0f0f0;
    }

    .btn {
      padding: 0.4rem 0.8rem;
      margin-right: 0.4rem;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }

    .btn-view { background-color: #0d6efd; }
    .btn-accept { background-color: #198754; }
    .btn-reject { background-color: #dc3545; }

    .main {
        display: grid;
        grid-template-columns: 7fr 3fr;
        gap: 1rem;
    }

    .main .right-side {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      .main {
        grid-template-columns: 1fr;
      }
      .card {
        padding: 10px;
        width: 100%;
      }
      .table-responsive {
        width: calc(100vw - 40px);
      }
    }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
    crossorigin=""/>
<!-- Leaflet JavaScript for OpenStreetMap -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
    crossorigin=""></script>

<!-- Leaflet heat -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<!-- ðŸ‘‹ Greeting -->
<h2 class="wish">Good {{ wish }}, {{ user.first_name }} {{ user.last_name }} 
  {% if user.user_type == 1 %}(Super Admin){% elif user.user_type == 2 %}(Admin){% endif %}ðŸ‘‹
</h2>

<div class="filter-container">
  <a href="?filter=last_28_days" class="{% if request.GET.filter == 'last_28_days' or not request.GET.filter %}active{% endif %}">Last 28 Days</a>  
  <a href="?filter=today" class="{% if request.GET.filter == 'today' %}active{% endif %}">Today</a>
  <a href="?filter=last_week" class="{% if request.GET.filter == 'last_week' %}active{% endif %}">Last Week</a>
  <a href="?filter=all" class="{% if request.GET.filter == 'all'%}active{% endif %}">Lifetime</a>
</div>

<!-- ðŸ“Š Dashboard Stats -->
<div class="main">
  <div class="left-side">
    <div class="dashboard-grid">
      <div class="card" id="total-post-chart"></div>
      <div class="card" id="pending-post-chart"></div>
    </div>

    <!-- Map section -->
    <div class="map-container">
      <div id="admin_map"></div>
    </div>

    <!-- ðŸ“‹ Table Section -->
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>10:23 AM</td>
            <td>Rayhan Hossain</td>
            <td>rayhan@gmail.com</td>
            <td>01xxxxxxxxx</td>
            <td>
              <button class="btn btn-view"><i class="fa-solid fa-eye"></i></button>
              <button class="btn btn-accept"><i class="fa-solid fa-check"></i></button>
              <button class="btn btn-reject"><i class="fa-solid fa-trash-can"></i></button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="right-side">
    <div class="card" id="post-donut-chart"></div>
    <div class="card" id="accept-pending-chart"></div>
  </div>
</div>

<script>
  const recent_post = {{ recent_post }};
  const pending_post = {{ pending_post }};
  const accept_post = {{ accept_post }};
  {% comment %} const accept_post = [5, 3, 1, 3, 7, 5, 3, 1, 3, 7, 5, 3, 1, 3, 7, 5, 3, 1, 3, 7, 5, 3, 1, 3, 7, 2, 6, 7] {% endcomment %}
  const negative_pending_post = {{ negative_pending_post }};
  {% comment %} const negative_pending_post = [5, 3, 1, 3, 7, 5, 3, 1, 3, 7, 5, 3, 1, 3, 7, 5, 3, 1, 3, 7, 5, 3, 1, 3, 7, 2, 6, 7] {% endcomment %}
  const days = {{ days|safe }};
  const accept_count = {{ accept_count }};
  const reject_count = {{ reject_count }};
  const pending_count = {{ pending_count }};
</script>

<script>
  const mapElement = document.getElementById('admin_map');
  let map;
  const posts = {{ posts|safe }} ;

  if (mapElement) {
    // Use the correct ID: admin_map
    map = L.map('admin_map'); 
    
    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 18
    }).addTo(map);

    // If you have this function defined somewhere
    if (typeof connectLocation === "function") {
      connectLocation();
    }
  }

  if (navigator.geolocation && map) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        // Center the map on user's location
        map.setView([lat, lng], 12);

        // Optionally, add a marker for the user
        // L.marker([lat, lng]).addTo(map)
        //   .bindPopup('Your location')
        //   .openPopup();
      }, 
      function(error) {
        console.error('Error getting location:', error);
        alert('Unable to get your location. Please check your permissions.');
      }
    );
  }
  function set_post() {
    // const basePostUrl = "{% url 'plastickothay:post' 'REPLACE_ID' %}".replace('REPLACE_ID', '');
    
    // var circle = L.circle([23.8103, 90.4125], {
    //     color: 'transparent',        // stroke color
    //     fillColor: '#30a3ff', // fill color
    //     fillOpacity: 0.5,
    //     radius: 500           // radius in meters
    // }).addTo(map);

    // circle.bindPopup("Radius: 500 m");

    var ICON_URL = "{% static 'icon.png' %}";

    var customIcon = L.icon({
        iconUrl: ICON_URL, // your icon image URL
        iconSize: [20, 30],  // size of icon
        iconAnchor: [20, 40], // point of icon which will correspond to marker's location
        popupAnchor: [0, -35] // popup position relative to icon
    });

    if (posts && posts.length > 0) {
        posts.forEach(post => {
            const postId = post._id.$oid;
            // const postUrl = basePostUrl + postId;
            const postUrl = "/post/" + postId
            L.marker([post.lat, post.lon], { icon: customIcon })
                .addTo(map)
                .bindPopup(`<b>${post.name}</b><br>Severity: ${post.severity}<br><a href="${postUrl}">Open post</a>`)
        });
    } else {
        console.warn("No posts found to add markers.");
    }
  }

  set_post() ;

  function set_heat() {
    let heatPoints = [];

    for (let i = 0; i < posts.length; i++) {
        let post = posts[i];
        // Assuming Django passed them as { lat: ..., lng: ... }
        heatPoints.push([post.lat, post.lon]);
    }

    L.heatLayer(heatPoints, {
      radius: 50,        // how big each point is in pixels
      blur: 5,          // smoothing
      maxZoom: 17,       // zoom level where points max out
      max: 1.0,          // intensity scale
      gradient: {        // optional custom colors
          0.4: 'blue',
          0.65: 'lime',
          1: 'red'
      }
    }).addTo(map);
  }

  set_heat() ;

</script>

{% endblock main-content %}
{% block title %}Dashboard{% endblock title %}
